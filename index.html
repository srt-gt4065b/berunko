<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë² ë£½ì½” ì–‘ë§ - ë§ˆë¼í† ë„ˆë¥¼ ìœ„í•œ ì„ íƒ</title>
    <style>
        /* [ìŠ¤íƒ€ì¼ ì •ì˜ êµ¬ì—­] */
        :root {
            --primary-color: #ff6b00;
            --text-color: #333;
            --bg-color: #f5f5f5;
            --admin-bg: #2c3e50; /* ê´€ë¦¬ì í…Œë§ˆìƒ‰ */
            --admin-accent: #3498db;
        }

        body {
            font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        /* ê³µí†µ í—¤ë” */
        header {
            background-color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 80px;
        }

        .hidden { display: none !important; }

        /* ì‡¼í•‘ëª° ë©”ì¸ */
        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            min-height: 200px; /* ë¡œë”© ë©”ì‹œì§€ ê³µê°„ í™•ë³´ */
        }

        .product-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            cursor: pointer;
            text-align: center;
            padding-bottom: 15px;
            position: relative; /* ì‚­ì œ ë²„íŠ¼ ìœ„ì¹˜ìš© */
        }
        .product-card:hover { transform: translateY(-5px); }

        .product-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background-color: #eee;
        }

        .product-name { font-weight: bold; margin: 10px 0 5px; }
        .product-price { color: var(--primary-color); font-weight: bold; }

        /* ë²„íŠ¼ ë° ì…ë ¥ í¼ */
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            margin-top: 10px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-secondary { background-color: #999; margin-top: 10px; }
        .btn-small { width: auto; padding: 5px 10px; font-size: 0.8rem; margin: 0; }
        .btn-danger { background-color: #e74c3c; color: white; }
        .btn-edit { background-color: #f39c12; color: white; margin-right: 5px;}

        /* ì¼ë°˜ ë·° ìŠ¤íƒ€ì¼ */
        .detail-view, .order-view, .success-view {
            background: white; padding: 20px; border-radius: 10px;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;
        }
        .detail-img { width: 100%; max-width: 300px; display: block; margin: 0 auto 20px; border-radius: 10px; }
        .price-summary { background-color: #fff8f0; padding: 15px; border-radius: 5px; margin: 20px 0; border: 1px solid #ffe0b2; }
        .bank-info { background-color: #e8f4fd; padding: 15px; border-radius: 5px; margin-bottom: 20px; color: #0056b3; font-weight: bold; text-align: center; }

        /* --- [ê´€ë¦¬ì ì „ìš© ìŠ¤íƒ€ì¼] --- */
        .admin-view {
            background-color: white; padding: 20px; border-radius: 10px; border: 2px solid var(--admin-bg);
        }
        .admin-nav {
            display: flex; gap: 10px; margin-bottom: 20px;
        }
        .admin-nav button {
            flex: 1; padding: 10px; border: none; background: #eee; cursor: pointer; border-radius: 5px;
            font-weight: bold;
        }
        .admin-nav button.active {
            background: var(--admin-bg); color: white;
        }

        /* í†µê³„ ëŒ€ì‹œë³´ë“œ */
        .stats-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;
        }
        .stat-card {
            background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #ddd;
        }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: var(--admin-bg); margin: 5px 0; }
        .stat-label { font-size: 0.9rem; color: #666; }

        /* ìƒí’ˆ ê´€ë¦¬ í…Œì´ë¸” */
        .admin-product-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px; border-bottom: 1px solid #eee;
        }
        .admin-product-info { display: flex; align-items: center; gap: 10px; }
        .admin-product-thumb { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; }

        /* ì£¼ë¬¸ ë‚´ì—­ ìŠ¤íƒ€ì¼ */
        .order-item { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px; }
        .order-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; color: #666; }
        .status-badge { padding: 3px 8px; border-radius: 10px; font-size: 0.8rem; }
        .status-pending { background: #ffe0b2; color: #e65100; }
        .status-completed { background: #c8e6c9; color: #2e7d32; }

        footer { margin-top: 50px; text-align: center; color: #aaa; font-size: 0.8rem; padding: 20px; cursor: pointer; }
        
        /* ë¡œë”©/ì—ëŸ¬ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .status-msg { text-align: center; width: 100%; padding: 20px; color: #666; }
        .error-msg { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>

    <header onclick="goHome()">
        <h1>ğŸ§¦ ë² ë£½ì½” ì–‘ë§</h1>
    </header>

    <div class="container">
        
        <!-- [í™”ë©´ 1] ë©”ì¸ í˜ì´ì§€ (ìƒí’ˆ ëª©ë¡) -->
        <div id="main-page">
            <h2 style="text-align:center; margin-bottom:30px;">ê¸°ë¡ ë‹¨ì¶•ì„ ìœ„í•œ ìµœê³ ì˜ ì„ íƒ</h2>
            <!-- DBì—ì„œ ìƒí’ˆì„ ë¶ˆëŸ¬ì™€ ì´ê³³ì— í‘œì‹œí•©ë‹ˆë‹¤ -->
            <div id="product-list" class="product-list">
                <div class="status-msg">
                    ìƒí’ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...<br>
                    (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)
                </div>
            </div>
        </div>

        <!-- [í™”ë©´ 2] ìƒì„¸ í˜ì´ì§€ -->
        <div id="product-detail-page" class="hidden detail-view">
            <button onclick="goHome()" style="background:none; border:none; cursor:pointer; font-size:1.5rem;">â† ë’¤ë¡œê°€ê¸°</button>
            <div style="text-align: center;">
                <img id="detail-img" class="detail-img" src="" alt="ìƒí’ˆì´ë¯¸ì§€">
                <h2 id="detail-name">ìƒí’ˆëª…</h2>
                <h3 id="detail-price" style="color:var(--primary-color)">0ì›</h3>
            </div>
            <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
            <div class="form-group">
                <label>ì‚¬ì´ì¦ˆ ì„ íƒ</label>
                <select id="option-size">
                    <option value="S">S (220-240mm)</option>
                    <option value="M">M (245-265mm)</option>
                    <option value="L">L (270-290mm)</option>
                </select>
            </div>
            <div class="form-group">
                <label>ìˆ˜ëŸ‰</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button type="button" onclick="changeQty(-1)" style="padding: 5px 15px;">-</button>
                    <input type="number" id="order-qty" value="1" readonly style="width: 50px; text-align: center;">
                    <button type="button" onclick="changeQty(1)" style="padding: 5px 15px;">+</button>
                </div>
            </div>
            <div class="price-summary">ì´ ê²°ì œ ê¸ˆì•¡ <span id="total-price-display" class="total-price">0ì›</span></div>
            <button class="btn" onclick="goToOrderForm()">êµ¬ë§¤í•˜ê¸°</button>
        </div>

        <!-- [í™”ë©´ 3] ì£¼ë¬¸ì„œ ì‘ì„± -->
        <div id="order-form-page" class="hidden order-view">
            <button onclick="goBackToDetail()" style="background:none; border:none; cursor:pointer; font-size:1.5rem;">â† ë’¤ë¡œê°€ê¸°</button>
            <h2>ì£¼ë¬¸ì„œ ì‘ì„±</h2>
            <div class="price-summary">
                <p><strong>ìƒí’ˆ:</strong> <span id="summary-product-name"></span></p>
                <p><strong>ì˜µì…˜:</strong> <span id="summary-option"></span> / <span id="summary-qty"></span>ê°œ</p>
                <hr>
                <p style="text-align: right;">ê²°ì œ ê¸ˆì•¡: <span id="summary-total" style="font-weight:bold; color:var(--primary-color)"></span></p>
            </div>
            <div class="bank-info">êµ­ë¯¼ì€í–‰ 123-456-789012 (ë² ë£½ì½”)</div>
            <form id="order-form">
                <div class="form-group"><label>ì£¼ë¬¸ì ì´ë¦„</label><input type="text" id="user-name" required placeholder="í™ê¸¸ë™"></div>
                <div class="form-group"><label>ì—°ë½ì²˜</label><input type="tel" id="user-phone" required placeholder="010-1234-5678"></div>
                <div class="form-group"><label>ë°°ì†¡ ì£¼ì†Œ</label><input type="text" id="user-address" required placeholder="ì„œìš¸ì‹œ ..."></div>
                <div class="form-group"><label>ì…ê¸ˆìëª…</label><input type="text" id="deposit-name" required placeholder="í•„ìˆ˜ ì…ë ¥"></div>
                <button type="submit" class="btn" id="btn-order-submit">ì£¼ë¬¸ ì™„ë£Œí•˜ê¸°</button>
            </form>
        </div>

        <!-- [í™”ë©´ 4] ì£¼ë¬¸ ì™„ë£Œ -->
        <div id="success-page" class="hidden success-view" style="text-align: center; padding: 50px 20px;">
            <div style="font-size: 3rem;">âœ…</div>
            <h2>ì£¼ë¬¸ ì„±ê³µ!</h2>
            <p><strong><span id="final-price"></span>ì›</strong>ì„ ì…ê¸ˆí•´ ì£¼ì„¸ìš”.</p>
            <button class="btn btn-secondary" onclick="goHome()">í™ˆìœ¼ë¡œ</button>
        </div>

        <!-- [í™”ë©´ 5] ê´€ë¦¬ì í˜ì´ì§€ (í™•ì¥ë¨) -->
        <div id="admin-page" class="hidden admin-view">
            <h2>ğŸ‘®â€â™‚ï¸ ê´€ë¦¬ì ëª¨ë“œ</h2>
            
            <!-- ê´€ë¦¬ì íƒ­ ë©”ë‰´ -->
            <div class="admin-nav">
                <button onclick="switchAdminTab('orders')" id="tab-btn-orders" class="active">ì£¼ë¬¸ ê´€ë¦¬</button>
                <button onclick="switchAdminTab('products')" id="tab-btn-products">ìƒí’ˆ ê´€ë¦¬</button>
                <button onclick="switchAdminTab('stats')" id="tab-btn-stats">ë§¤ì¶œ í†µê³„</button>
            </div>

            <!-- íƒ­ 1: ì£¼ë¬¸ ëª©ë¡ -->
            <div id="admin-tab-orders">
                <h3>ì‹¤ì‹œê°„ ì£¼ë¬¸ í˜„í™©</h3>
                <div id="admin-order-list">ë¡œë”© ì¤‘...</div>
            </div>

            <!-- íƒ­ 2: ìƒí’ˆ ê´€ë¦¬ (ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ) -->
            <div id="admin-tab-products" class="hidden">
                <h3>ìƒí’ˆ ë“±ë¡ ë° ê´€ë¦¬</h3>
                
                <!-- ìƒí’ˆ ë“±ë¡/ìˆ˜ì • í¼ -->
                <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #ddd;">
                    <h4 style="margin-top:0;" id="product-form-title">ìƒˆ ìƒí’ˆ ë“±ë¡</h4>
                    <form id="add-product-form">
                        <input type="hidden" id="edit-prod-id"> <!-- ìˆ˜ì • ëª¨ë“œì¼ ë•Œ ID ì €ì¥ -->
                        <div class="form-group">
                            <input type="text" id="new-prod-name" placeholder="ìƒí’ˆëª… (ì˜ˆ: ë² ë£½ì½” ìš¸íŠ¸ë¼ ì‚­ìŠ¤)" required>
                        </div>
                        <div class="form-group">
                            <input type="number" id="new-prod-price" placeholder="ê°€ê²© (ì˜ˆ: 15000)" required>
                        </div>
                        <div class="form-group">
                            <input type="text" id="new-prod-img" placeholder="ì´ë¯¸ì§€ URL (ì˜ˆ: https://...)" required>
                            <small style="color:#888;">* íŒ: placehold.co ì‚¬ì´íŠ¸ ì´ë¯¸ì§€ë¥¼ ì“°ë©´ í¸í•©ë‹ˆë‹¤.</small>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button type="submit" class="btn btn-small" id="btn-save-product">ìƒí’ˆ ì¶”ê°€í•˜ê¸°</button>
                            <button type="button" class="btn btn-small btn-secondary hidden" id="btn-cancel-edit" onclick="cancelEdit()">ì·¨ì†Œ</button>
                        </div>
                    </form>
                </div>

                <!-- ìƒí’ˆ ëª©ë¡ (ì‚­ì œ/ìˆ˜ì •ìš©) -->
                <h4>ë“±ë¡ëœ ìƒí’ˆ ëª©ë¡</h4>
                <div id="admin-product-list">
                    <!-- JSë¡œ ì±„ì›Œì§ -->
                </div>
            </div>

            <!-- íƒ­ 3: ë§¤ì¶œ í†µê³„ (ì£¼ë¬¸ ìš”ì•½) -->
            <div id="admin-tab-stats" class="hidden">
                <h3>ğŸ“Š ì „ì²´ ë§¤ì¶œ í˜„í™©</h3>
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-label">ì´ ë§¤ì¶œì•¡</div>
                        <div class="stat-value" id="stat-total-revenue">0ì›</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì´ ì£¼ë¬¸ ê±´ìˆ˜</div>
                        <div class="stat-value" id="stat-total-count">0ê±´</div>
                    </div>
                </div>

                <!-- ì¶”ê°€ í†µê³„: ë°°ì†¡ í˜„í™© -->
                <h4>ë°°ì†¡ ì²˜ë¦¬ í˜„í™©</h4>
                <div class="stats-container" style="margin-bottom:20px;">
                    <div class="stat-card" style="background-color:#fff3e0;">
                        <div class="stat-label">ë°°ì†¡ ëŒ€ê¸°</div>
                        <div class="stat-value" id="stat-pending-count" style="color:#e65100">0ê±´</div>
                    </div>
                    <div class="stat-card" style="background-color:#e8f5e9;">
                        <div class="stat-label">ë°°ì†¡ ì™„ë£Œ</div>
                        <div class="stat-value" id="stat-completed-count" style="color:#2e7d32">0ê±´</div>
                    </div>
                </div>
                
                <h4>ìƒí’ˆë³„ íŒë§¤ëŸ‰</h4>
                <ul id="stat-product-breakdown" style="list-style: none; padding: 0;">
                    <!-- JSë¡œ ì±„ì›Œì§ -->
                </ul>
            </div>

            <button class="btn btn-secondary" onclick="goHome()" style="margin-top:20px;">ì‡¼í•‘ëª°ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>

    </div>

    <footer onclick="goToAdmin()">
        Â© 2024 Verunco Socks Corp. (ê´€ë¦¬ì ëª¨ë“œ: í•˜ë‹¨ í´ë¦­)
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 1. Firebase ì´ˆê¸°í™”
        
        // [ì•ˆë‚´] ì‹¤ì œ ì›¹ì‚¬ì´íŠ¸ì— ë°°í¬í•  ë•ŒëŠ” ì•„ë˜ ì£¼ì„ì„ í’€ê³ , íŒŒì´ì–´ë² ì´ìŠ¤ ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ ì„¤ì •ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.
        /*
        const firebaseConfig = {
            apiKey: "AIzaSyDHC0F79_7jnC-YwV48Tiusg0NMHdtPhj4",
  authDomain: "berunko-5c8bf.firebaseapp.com",
  projectId: "berunko-5c8bf",
  storageBucket: "berunko-5c8bf.firebasestorage.app",
  messagingSenderId: "933523639470",
  appId: "1:933523639470:web:33967d8bc13e284a80f13f"
        };
        */

        // Canvas í™˜ê²½ì—ì„œëŠ” ì‹œìŠ¤í…œ ì„¤ì •ì„ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤. (ì™¸ë¶€ ì‚¬ìš© ì‹œ ìœ„ ì„¤ì •ê°’ì„ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì • í•„ìš”)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let products = [];
        let selectedProduct = null;
        let currentQty = 1;
        let allOrders = [];

        // 2. ì¸ì¦ ë° ë¦¬ìŠ¤ë„ˆ ì‹œì‘
        async function initAuth() {
            try { 
                await signInAnonymously(auth); 
                console.log("Firebase ì¸ì¦ ì„±ê³µ");
            } 
            catch (e) { 
                console.error("ì¸ì¦ ì‹¤íŒ¨:", e); 
                document.getElementById('product-list').innerHTML = `<div class="status-msg error-msg">DB ì—°ê²° ì‹¤íŒ¨ (ì¸ì¦ ì˜¤ë¥˜)<br>${e.message}</div>`;
            }
        }
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                setupProductListener(); 
                setupOrderListener();
            }
        });
        initAuth();

        // [ê¸°ëŠ¥ 1] ìƒí’ˆ ë°ì´í„° ì‹¤ì‹œê°„ ë™ê¸°í™” (CRUD: Read)
        function setupProductListener() {
            const listContainer = document.getElementById('product-list');
            const adminListContainer = document.getElementById('admin-product-list');

            try {
                // ì¿¼ë¦¬ ìƒì„±
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'products'), orderBy('createdAt', 'desc'));
                
                onSnapshot(q, (snapshot) => {
                    // ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
                    if (snapshot.empty) {
                        if (!products.length) {
                             console.log("ë°ì´í„° ì—†ìŒ. ì´ˆê¸° ë°ì´í„° ìƒì„± ì‹œë„...");
                             listContainer.innerHTML = `<div class="status-msg">ê¸°ë³¸ ìƒí’ˆ ë°ì´í„°ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...<br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>`;
                             seedInitialProducts().catch(err => {
                                 console.error("ì´ˆê¸° ë°ì´í„° ìƒì„± ì‹¤íŒ¨:", err);
                                 listContainer.innerHTML = `<div class="status-msg error-msg">ì´ˆê¸° ë°ì´í„° ìƒì„± ì‹¤íŒ¨<br>${err.message}</div>`;
                             });
                             return;
                        } else {
                            // ì›ë˜ ë°ì´í„°ê°€ ìˆì—ˆëŠ”ë° ë‹¤ ì§€ì›Œì§„ ê²½ìš°
                            listContainer.innerHTML = "<div class='status-msg'>íŒë§¤ ì¤‘ì¸ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>";
                            adminListContainer.innerHTML = "<div class='status-msg'>ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>";
                            return;
                        }
                    }

                    products = [];
                    listContainer.innerHTML = "";
                    adminListContainer.innerHTML = "";

                    snapshot.forEach(docSnap => {
                        const p = { id: docSnap.id, ...docSnap.data() };
                        products.push(p);

                        // 1. ë©”ì¸ í™”ë©´: ìƒí’ˆ ì¹´ë“œ ìƒì„±
                        const card = document.createElement('div');
                        card.className = 'product-card';
                        card.onclick = () => window.showProductDetail(p.id);
                        card.innerHTML = `
                            <img src="${p.img}" class="product-img" onerror="this.src='https://placehold.co/300?text=No+Image'">
                            <div style="padding:10px;">
                                <div class="product-name">${p.name}</div>
                                <div class="product-price">${Number(p.price).toLocaleString()}ì›</div>
                            </div>
                        `;
                        listContainer.appendChild(card);

                        // 2. ê´€ë¦¬ì í™”ë©´: ë¦¬ìŠ¤íŠ¸ ìƒì„±
                        const adminItem = document.createElement('div');
                        adminItem.className = 'admin-product-item';
                        adminItem.innerHTML = `
                            <div class="admin-product-info">
                                <img src="${p.img}" class="admin-product-thumb">
                                <div>
                                    <strong>${p.name}</strong><br>
                                    ${Number(p.price).toLocaleString()}ì›
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-small btn-edit" onclick="editProduct('${p.id}')">ìˆ˜ì •</button>
                                <button class="btn btn-small btn-danger" onclick="deleteProduct('${p.id}')">ì‚­ì œ</button>
                            </div>
                        `;
                        adminListContainer.appendChild(adminItem);
                    });
                }, (error) => {
                    // onSnapshot ì—ëŸ¬ ì½œë°±
                    console.error("ë°ì´í„° ì½ê¸° ê¶Œí•œ/ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", error);
                    listContainer.innerHTML = `<div class="status-msg error-msg">ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ì˜¤ë¥˜: ${error.message}</div>`;
                });
            } catch (err) {
                console.error("ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì¤‘ ì˜¤ë¥˜:", err);
                listContainer.innerHTML = `<div class="status-msg error-msg">ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>${err.message}</div>`;
            }
        }

        async function seedInitialProducts() {
            const initialData = [
                { name: "ë² ë£½ì½” ìŠ¤í”¼ë“œ (ì´ˆê²½ëŸ‰)", price: 12000, img: "https://placehold.co/300x300/orange/white?text=Speed" },
                { name: "ë² ë£½ì½” ë§ˆë¼í†¤ í”„ë¡œ", price: 15000, img: "https://placehold.co/300x300/navy/white?text=Marathon" },
                { name: "ë² ë£½ì½” ë¦¬ì»¤ë²„ë¦¬", price: 18000, img: "https://placehold.co/300x300/green/white?text=Recovery" },
                { name: "ë² ë£½ì½” íŠ¸ë ˆì¼", price: 14000, img: "https://placehold.co/300x300/brown/white?text=Trail" }
            ];
            const promises = initialData.map(p => 
                addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), {
                    ...p, createdAt: serverTimestamp()
                })
            );
            await Promise.all(promises);
            console.log("ì´ˆê¸° ìƒí’ˆ ë°ì´í„° ìƒì„± ì™„ë£Œ");
        }

        // [ê¸°ëŠ¥ 2] ì£¼ë¬¸ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ & í†µê³„ ì§‘ê³„
        function setupOrderListener() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderBy('orderDate', 'desc'));

            onSnapshot(q, (snapshot) => {
                const listContainer = document.getElementById('admin-order-list');
                
                allOrders = [];
                let html = "";

                if (snapshot.empty) html = "<div class='status-msg'>ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>";

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    allOrders.push(data);

                    const date = data.orderDate ? new Date(data.orderDate.seconds * 1000).toLocaleString() : "ë°©ê¸ˆ ì „";
                    const statusClass = data.status === 'ë°°ì†¡ì™„ë£Œ' ? 'status-completed' : 'status-pending';
                    
                    html += `
                        <div class="order-item">
                            <div class="order-header">
                                <span>${date}</span>
                                <span class="status-badge ${statusClass}">${data.status}</span>
                            </div>
                            <div><strong>[${data.productName}]</strong> ${data.qty}ê°œ (${Number(data.totalPrice).toLocaleString()}ì›)</div>
                            <div style="font-size:0.8rem; color:#666; margin-top:5px;">
                                ${data.userName} / ${data.userAddress}
                            </div>
                            ${data.status !== 'ë°°ì†¡ì™„ë£Œ' ? 
                                `<button class="btn btn-small" style="margin-top:5px;" onclick="updateOrderStatus('${docSnap.id}')">ë°°ì†¡ì²˜ë¦¬</button>` : ''}
                        </div>
                    `;
                });
                listContainer.innerHTML = html;
                calculateStats();
            }, (error) => {
                console.error("ì£¼ë¬¸ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
                document.getElementById('admin-order-list').innerHTML = `<div class="status-msg error-msg">ì£¼ë¬¸ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨<br>${error.message}</div>`;
            });
        }

        // [ê¸°ëŠ¥ 3] í†µê³„ ê³„ì‚° (ì£¼ë¬¸ ìš”ì•½)
        function calculateStats() {
            let totalRevenue = 0;
            let productCounts = {};
            let pendingCount = 0;
            let completedCount = 0;

            allOrders.forEach(order => {
                totalRevenue += (order.totalPrice || 0);
                
                // ë°°ì†¡ ìƒíƒœ ì¹´ìš´íŠ¸
                if (order.status === 'ë°°ì†¡ì™„ë£Œ') completedCount++;
                else pendingCount++;

                const pName = order.productName || "ì•Œìˆ˜ì—†ìŒ";
                if (!productCounts[pName]) productCounts[pName] = 0;
                productCounts[pName] += (order.qty || 0);
            });

            document.getElementById('stat-total-revenue').innerText = totalRevenue.toLocaleString() + "ì›";
            document.getElementById('stat-total-count').innerText = allOrders.length + "ê±´";
            document.getElementById('stat-pending-count').innerText = pendingCount + "ê±´";
            document.getElementById('stat-completed-count').innerText = completedCount + "ê±´";

            const breakdownList = document.getElementById('stat-product-breakdown');
            breakdownList.innerHTML = "";
            for (const [name, count] of Object.entries(productCounts)) {
                const li = document.createElement('li');
                li.style.padding = "5px 0";
                li.style.borderBottom = "1px solid #eee";
                li.innerHTML = `<span>${name}</span> <span style="float:right; font-weight:bold;">${count}ê°œ</span>`;
                breakdownList.appendChild(li);
            }
        }

        // [ê¸°ëŠ¥ 4] ìƒí’ˆ ì¶”ê°€ ë° ìˆ˜ì • ì²˜ë¦¬ (CRUD: Create & Update)
        document.getElementById('add-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-prod-id').value; // ìˆ˜ì • ëª¨ë“œì¸ì§€ í™•ì¸
            const name = document.getElementById('new-prod-name').value;
            const price = Number(document.getElementById('new-prod-price').value);
            const img = document.getElementById('new-prod-img').value;

            try {
                if (id) {
                    // ìˆ˜ì • (Update)
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id), {
                        name, price, img
                    });
                    alert("ìƒí’ˆì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    window.cancelEdit(); // í¼ ì´ˆê¸°í™”
                } else {
                    // ì¶”ê°€ (Create)
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), {
                        name, price, img, createdAt: serverTimestamp()
                    });
                    alert("ìƒˆ ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    e.target.reset();
                }
            } catch (err) {
                console.error(err);
                alert("ì²˜ë¦¬ ì‹¤íŒ¨: " + err.message);
            }
        });

        // [ê¸°ëŠ¥ 5] ìƒí’ˆ ìˆ˜ì • ëª¨ë“œ ì§„ì…
        window.editProduct = (id) => {
            const p = products.find(prod => prod.id === id);
            if (!p) return;

            document.getElementById('product-form-title').innerText = "ìƒí’ˆ ìˆ˜ì • ëª¨ë“œ";
            document.getElementById('edit-prod-id').value = id;
            document.getElementById('new-prod-name').value = p.name;
            document.getElementById('new-prod-price').value = p.price;
            document.getElementById('new-prod-img').value = p.img;
            
            document.getElementById('btn-save-product').innerText = "ìˆ˜ì •ì‚¬í•­ ì €ì¥";
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            
            // í¼ ìª½ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
            document.getElementById('add-product-form').scrollIntoView({ behavior: 'smooth' });
        };

        // [ê¸°ëŠ¥ 6] ìƒí’ˆ ìˆ˜ì • ì·¨ì†Œ
        window.cancelEdit = () => {
            document.getElementById('product-form-title').innerText = "ìƒˆ ìƒí’ˆ ë“±ë¡";
            document.getElementById('edit-prod-id').value = "";
            document.getElementById('add-product-form').reset();
            
            document.getElementById('btn-save-product').innerText = "ìƒí’ˆ ì¶”ê°€í•˜ê¸°";
            document.getElementById('btn-cancel-edit').classList.add('hidden');
        };

        // [ê¸°ëŠ¥ 7] ìƒí’ˆ ì‚­ì œ (CRUD: Delete)
        window.deleteProduct = async (id) => {
            if(!confirm("ì •ë§ ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id));
            } catch(err) {
                console.error(err);
                alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message);
            }
        };

        // --- UI í—¬í¼ í•¨ìˆ˜ë“¤ ---
        window.switchView = (viewId) => {
            ['main-page', 'product-detail-page', 'order-form-page', 'success-page', 'admin-page'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
            window.scrollTo(0, 0);
        };
        
        window.switchAdminTab = (tabName) => {
            ['orders', 'products', 'stats'].forEach(t => {
                document.getElementById(`tab-btn-${t}`).classList.remove('active');
                document.getElementById(`admin-tab-${t}`).classList.add('hidden');
            });
            document.getElementById(`tab-btn-${tabName}`).classList.add('active');
            document.getElementById(`admin-tab-${tabName}`).classList.remove('hidden');
        };

        window.goHome = () => { selectedProduct = null; window.switchView('main-page'); };
        
        window.showProductDetail = (id) => {
            selectedProduct = products.find(p => p.id === id);
            if(!selectedProduct) return;
            currentQty = 1;
            document.getElementById('detail-img').src = selectedProduct.img;
            document.getElementById('detail-name').innerText = selectedProduct.name;
            document.getElementById('detail-price').innerText = Number(selectedProduct.price).toLocaleString() + "ì›";
            document.getElementById('order-qty').value = currentQty;
            window.updateTotalPrice();
            window.switchView('product-detail-page');
        };

        window.changeQty = (change) => {
            currentQty += change;
            if (currentQty < 1) currentQty = 1;
            document.getElementById('order-qty').value = currentQty;
            window.updateTotalPrice();
        };

        window.updateTotalPrice = () => {
            const total = selectedProduct.price * currentQty;
            document.getElementById('total-price-display').innerText = total.toLocaleString() + "ì›";
        };

        window.goToOrderForm = () => {
            const size = document.getElementById('option-size').value;
            const total = selectedProduct.price * currentQty;
            document.getElementById('summary-product-name').innerText = selectedProduct.name;
            document.getElementById('summary-option').innerText = size;
            document.getElementById('summary-qty').innerText = currentQty;
            document.getElementById('summary-total').innerText = total.toLocaleString() + "ì›";
            window.switchView('order-form-page');
        };

        window.goBackToDetail = () => window.switchView('product-detail-page');
        
        // [ìˆ˜ì •ë¨] ê´€ë¦¬ì ì§„ì… ì‹œ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ê¸°ëŠ¥ ì¶”ê°€
        window.goToAdmin = () => { 
            const password = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (password === "1234") { // êµìœ¡ìš© ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
                window.switchView('admin-page');
            } else if (password !== null) { // ì·¨ì†Œ ë²„íŠ¼ì„ ëˆ„ë¥´ì§€ ì•Šì•˜ëŠ”ë° í‹€ë¦° ê²½ìš°
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (íŒíŠ¸: 1234)");
            }
        };

        document.getElementById('order-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return alert("ì´ˆê¸°í™” ì¤‘...");
            const btn = document.getElementById('btn-order-submit');
            btn.disabled = true; btn.innerText = "ì²˜ë¦¬ ì¤‘...";

            const orderData = {
                productName: selectedProduct.name,
                option: document.getElementById('option-size').value,
                qty: currentQty,
                totalPrice: selectedProduct.price * currentQty,
                userName: document.getElementById('user-name').value,
                userPhone: document.getElementById('user-phone').value,
                userAddress: document.getElementById('user-address').value,
                depositName: document.getElementById('deposit-name').value,
                orderDate: serverTimestamp(),
                status: "ì…ê¸ˆëŒ€ê¸°"
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderData);
                document.getElementById('final-price').innerText = orderData.totalPrice.toLocaleString();
                window.switchView('success-page');
                e.target.reset();
            } catch(err) { alert("ì£¼ë¬¸ ì‹¤íŒ¨: " + err.message); }
            finally { btn.disabled = false; btn.innerText = "ì£¼ë¬¸ ì™„ë£Œí•˜ê¸°"; }
        });

        window.updateOrderStatus = async (docId) => {
            if(!confirm("ë°°ì†¡ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', docId), { status: "ë°°ì†¡ì™„ë£Œ" });
        };
    </script>
</body>
</html>
